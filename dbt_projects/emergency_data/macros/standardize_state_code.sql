
{% macro standardize_state_code(state_column) %}
    CASE 
        WHEN LENGTH(TRIM({{ state_column }})) = 2 THEN UPPER(TRIM({{ state_column }}))
        WHEN LOWER(TRIM({{ state_column }})) = 'colorado' THEN 'CO'
        WHEN LOWER(TRIM({{ state_column }})) = 'california' THEN 'CA'
        WHEN LOWER(TRIM({{ state_column }})) = 'texas' THEN 'TX'
        WHEN LOWER(TRIM({{ state_column }})) = 'florida' THEN 'FL'
        WHEN LOWER(TRIM({{ state_column }})) = 'new york' THEN 'NY'
        WHEN LOWER(TRIM({{ state_column }})) = 'pennsylvania' THEN 'PA'
        WHEN LOWER(TRIM({{ state_column }})) = 'illinois' THEN 'IL'
        WHEN LOWER(TRIM({{ state_column }})) = 'ohio' THEN 'OH'
        WHEN LOWER(TRIM({{ state_column }})) = 'georgia' THEN 'GA'
        WHEN LOWER(TRIM({{ state_column }})) = 'north carolina' THEN 'NC'
        WHEN LOWER(TRIM({{ state_column }})) = 'michigan' THEN 'MI'
        WHEN LOWER(TRIM({{ state_column }})) = 'new jersey' THEN 'NJ'
        WHEN LOWER(TRIM({{ state_column }})) = 'virginia' THEN 'VA'
        WHEN LOWER(TRIM({{ state_column }})) = 'washington' THEN 'WA'
        WHEN LOWER(TRIM({{ state_column }})) = 'arizona' THEN 'AZ'
        WHEN LOWER(TRIM({{ state_column }})) = 'massachusetts' THEN 'MA'
        WHEN LOWER(TRIM({{ state_column }})) = 'tennessee' THEN 'TN'
        WHEN LOWER(TRIM({{ state_column }})) = 'indiana' THEN 'IN'
        WHEN LOWER(TRIM({{ state_column }})) = 'missouri' THEN 'MO'
        WHEN LOWER(TRIM({{ state_column }})) = 'maryland' THEN 'MD'
        WHEN LOWER(TRIM({{ state_column }})) = 'wisconsin' THEN 'WI'
        WHEN LOWER(TRIM({{ state_column }})) = 'minnesota' THEN 'MN'
        WHEN LOWER(TRIM({{ state_column }})) = 'louisiana' THEN 'LA'
        WHEN LOWER(TRIM({{ state_column }})) = 'alabama' THEN 'AL'
        WHEN LOWER(TRIM({{ state_column }})) = 'kentucky' THEN 'KY'
        WHEN LOWER(TRIM({{ state_column }})) = 'oregon' THEN 'OR'
        WHEN LOWER(TRIM({{ state_column }})) = 'oklahoma' THEN 'OK'
        WHEN LOWER(TRIM({{ state_column }})) = 'connecticut' THEN 'CT'
        WHEN LOWER(TRIM({{ state_column }})) = 'south carolina' THEN 'SC'
        WHEN LOWER(TRIM({{ state_column }})) = 'iowa' THEN 'IA'
        WHEN LOWER(TRIM({{ state_column }})) = 'mississippi' THEN 'MS'
        WHEN LOWER(TRIM({{ state_column }})) = 'arkansas' THEN 'AR'
        WHEN LOWER(TRIM({{ state_column }})) = 'kansas' THEN 'KS'
        WHEN LOWER(TRIM({{ state_column }})) = 'utah' THEN 'UT'
        WHEN LOWER(TRIM({{ state_column }})) = 'nevada' THEN 'NV'
        WHEN LOWER(TRIM({{ state_column }})) = 'new mexico' THEN 'NM'
        WHEN LOWER(TRIM({{ state_column }})) = 'west virginia' THEN 'WV'
        WHEN LOWER(TRIM({{ state_column }})) = 'nebraska' THEN 'NE'
        WHEN LOWER(TRIM({{ state_column }})) = 'idaho' THEN 'ID'
        WHEN LOWER(TRIM({{ state_column }})) = 'hawaii' THEN 'HI'
        WHEN LOWER(TRIM({{ state_column }})) = 'new hampshire' THEN 'NH'
        WHEN LOWER(TRIM({{ state_column }})) = 'maine' THEN 'ME'
        WHEN LOWER(TRIM({{ state_column }})) = 'montana' THEN 'MT'
        WHEN LOWER(TRIM({{ state_column }})) = 'rhode island' THEN 'RI'
        WHEN LOWER(TRIM({{ state_column }})) = 'delaware' THEN 'DE'
        WHEN LOWER(TRIM({{ state_column }})) = 'south dakota' THEN 'SD'
        WHEN LOWER(TRIM({{ state_column }})) = 'north dakota' THEN 'ND'
        WHEN LOWER(TRIM({{ state_column }})) = 'alaska' THEN 'AK'
        WHEN LOWER(TRIM({{ state_column }})) = 'vermont' THEN 'VT'
        WHEN LOWER(TRIM({{ state_column }})) = 'wyoming' THEN 'WY'
        WHEN LOWER(TRIM({{ state_column }})) = 'district of columbia' THEN 'DC'
        WHEN LOWER(TRIM({{ state_column }})) = 'puerto rico' THEN 'PR'
        WHEN LOWER(TRIM({{ state_column }})) = 'virgin islands' THEN 'VI'
        -- Handle FIPS codes to state codes
        WHEN TRIM({{ state_column }}) = '01' THEN 'AL'
        WHEN TRIM({{ state_column }}) = '02' THEN 'AK'
        WHEN TRIM({{ state_column }}) = '04' THEN 'AZ'
        WHEN TRIM({{ state_column }}) = '05' THEN 'AR'
        WHEN TRIM({{ state_column }}) = '06' THEN 'CA'
        WHEN TRIM({{ state_column }}) = '08' THEN 'CO'
        WHEN TRIM({{ state_column }}) = '09' THEN 'CT'
        WHEN TRIM({{ state_column }}) = '10' THEN 'DE'
        WHEN TRIM({{ state_column }}) = '11' THEN 'DC'
        WHEN TRIM({{ state_column }}) = '12' THEN 'FL'
        WHEN TRIM({{ state_column }}) = '13' THEN 'GA'
        WHEN TRIM({{ state_column }}) = '15' THEN 'HI'
        WHEN TRIM({{ state_column }}) = '16' THEN 'ID'
        WHEN TRIM({{ state_column }}) = '17' THEN 'IL'
        WHEN TRIM({{ state_column }}) = '18' THEN 'IN'
        WHEN TRIM({{ state_column }}) = '19' THEN 'IA'
        WHEN TRIM({{ state_column }}) = '20' THEN 'KS'
        WHEN TRIM({{ state_column }}) = '21' THEN 'KY'
        WHEN TRIM({{ state_column }}) = '22' THEN 'LA'
        WHEN TRIM({{ state_column }}) = '23' THEN 'ME'
        WHEN TRIM({{ state_column }}) = '24' THEN 'MD'
        WHEN TRIM({{ state_column }}) = '25' THEN 'MA'
        WHEN TRIM({{ state_column }}) = '26' THEN 'MI'
        WHEN TRIM({{ state_column }}) = '27' THEN 'MN'
        WHEN TRIM({{ state_column }}) = '28' THEN 'MS'
        WHEN TRIM({{ state_column }}) = '29' THEN 'MO'
        WHEN TRIM({{ state_column }}) = '30' THEN 'MT'
        WHEN TRIM({{ state_column }}) = '31' THEN 'NE'
        WHEN TRIM({{ state_column }}) = '32' THEN 'NV'
        WHEN TRIM({{ state_column }}) = '33' THEN 'NH'
        WHEN TRIM({{ state_column }}) = '34' THEN 'NJ'
        WHEN TRIM({{ state_column }}) = '35' THEN 'NM'
        WHEN TRIM({{ state_column }}) = '36' THEN 'NY'
        WHEN TRIM({{ state_column }}) = '37' THEN 'NC'
        WHEN TRIM({{ state_column }}) = '38' THEN 'ND'
        WHEN TRIM({{ state_column }}) = '39' THEN 'OH'
        WHEN TRIM({{ state_column }}) = '40' THEN 'OK'
        WHEN TRIM({{ state_column }}) = '41' THEN 'OR'
        WHEN TRIM({{ state_column }}) = '42' THEN 'PA'
        WHEN TRIM({{ state_column }}) = '44' THEN 'RI'
        WHEN TRIM({{ state_column }}) = '45' THEN 'SC'
        WHEN TRIM({{ state_column }}) = '46' THEN 'SD'
        WHEN TRIM({{ state_column }}) = '47' THEN 'TN'
        WHEN TRIM({{ state_column }}) = '48' THEN 'TX'
        WHEN TRIM({{ state_column }}) = '49' THEN 'UT'
        WHEN TRIM({{ state_column }}) = '50' THEN 'VT'
        WHEN TRIM({{ state_column }}) = '51' THEN 'VA'
        WHEN TRIM({{ state_column }}) = '53' THEN 'WA'
        WHEN TRIM({{ state_column }}) = '54' THEN 'WV'
        WHEN TRIM({{ state_column }}) = '55' THEN 'WI'
        WHEN TRIM({{ state_column }}) = '56' THEN 'WY'
        WHEN TRIM({{ state_column }}) = '72' THEN 'PR'
        WHEN TRIM({{ state_column }}) = '78' THEN 'VI'
        -- Default fallback
        ELSE UPPER(LEFT(TRIM({{ state_column }}), 2))
    END
{% endmacro %}
